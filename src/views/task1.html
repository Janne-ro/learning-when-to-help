<div ng-controller="Task1Ctrl">
  <md-content layout-padding>

    <!-- AI Usage Message -->
    <md-toolbar class="md-primary md-hue-2 headbar-tasks" layout="row" layout-align="center center">
        <div>
            <label class="headbar-text">{{ aiMessage }}</label>
        </div>
    </md-toolbar>


    <!-- Task Instructions -->
    <h3>Task 1: Lorem Ipsum Writing Exercise</h3>
    <p>
      Answer the questions based on the provided text:
    </p>
    <blockquote>
      "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur vel nibh et lorem
      congue vehicula. Integer tempor dolor at felis lacinia, ac egestas neque vehicula."
    </blockquote>

<!-- LLM Interaction Section (shown only if allowAI == true) -->
<div ng-if="allowAI" class="llm-interaction-section" layout="column" layout-align="start stretch">

  <!-- chat wrapper with background (no duplicate border) -->
  <div class="chat-wrapper">

    <!-- header -->
    <div class="chat-header" layout="row" layout-align="space-between center">
      <h4>AI Assistant</h4>
      <!-- clear conversation button -->
      <div>
        <md-button class="md-raised md-warn" ng-click="clearConversation()" aria-label="Clear conversation">
          Clear conversation
        </md-button>
      </div>
    </div>

    <div class="chat-container">
      <!-- messages -->
      <div id="llm-messages" class="chat-messages">

        <!-- message rows with avatar + bubble -->
        <div ng-repeat="m in messages track by $index"
             class="message-row"
             ng-class="{'user': m.who === 'user', 'ai': m.who === 'ai'}">

          <!-- avatar (position controlled by .message-row.{ai|user} via flex-direction) -->
          <div class="avatar" ng-class="{'ai': m.who === 'ai', 'user': m.who === 'user'}">
            <span ng-if="m.who === 'ai'">AI</span>
            <span ng-if="m.who === 'user'">You</span>
          </div>

          <!-- bubble -->
          <div class="message" ng-class="{'ai': m.who === 'ai', 'user': m.who === 'user'}">
            <span ng-bind="m.text"></span>
          </div>
        </div>

        <!-- thinking indicator (match same structure so it lines up correctly) -->
        <div class="message-row ai" ng-if="llm.loading">
          <div class="avatar ai">AI</div>
          <div class="message ai typing">AI is thinking...</div>
        </div>

      </div>

      <!-- input (anchored inside chat-container by CSS) -->
      <div class="chat-input">
        <md-input-container class="md-block">
          <textarea
            ng-model="llm.prompt"
            ng-keydown="handleKeydown($event)"
            rows="2"
            placeholder="&nbsp;Write a message (Enter to send, Shift+Enter for newline)"></textarea>
        </md-input-container>

        <div class="input-actions">
          <md-button class="md-raised md-primary" ng-click="sendToLLM()" ng-disabled="llm.loading" aria-label="Send message">
            {{ llm.loading ? 'Thinking...' : 'Send' }}
          </md-button>
        </div>
      </div>
    </div>

  </div> <!-- end chat-wrapper -->

</div>


    <!-- Example Dummy Questions -->
    <h4>Answer the following questions:</h4>
    <div ng-repeat="q in questions track by $index" style="margin-bottom: 15px;">
      <p><strong>Q{{$index + 1}}.</strong> {{q}}</p>
      
      <md-input-container class="md-block">
        <label>Your answer</label>
        <input type="text" ng-model="answers[$index]" />
      </md-input-container>

      <!-- Show incorrect message only if it exists -->
      <p ng-if="messagesQuestionsIncorrect[$index]" style="color: #8B0000; font-weight: 500; margin-top: -5px;">
        {{messagesQuestionsIncorrect[$index]}}
      </p>
    </div>

    <!-- Button and error message on same line -->
    <div layout="row" layout-align="left center" style="margin-top:20px; gap:10px;">
        <md-button ng-click="submitTask()" type="submit" class="md-raised md-primary">Next stage</md-button> 

        <!-- Error message right next to button -->
        <span ng-if="msg" style="color: #8B0000; font-weight: 600;">{{msg}}</span> 
    </div>

  </md-content>
</div>
