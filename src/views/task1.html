<div ng-controller="Task1Ctrl">
  <md-content layout-padding>

    <!-- AI Usage Message -->
    <md-toolbar class="md-primary md-hue-2 headbar-tasks" layout="row" layout-align="center center">
        <div>
            <label class="headbar-text">{{ aiMessage }}</label>
        </div>
    </md-toolbar>


    <!-- Task Instructions -->
    <h3>Task 1: Lorem Ipsum Writing Exercise</h3>
    <p>
      Answer the questions based on the provided text:
    </p>
    <blockquote>
      "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur vel nibh et lorem
      congue vehicula. Integer tempor dolor at felis lacinia, ac egestas neque vehicula."
    </blockquote>

<!-- LLM Interaction Section (shown only if allowAI == true) -->
<div ng-if="allowAI" class="llm-interaction-section" layout="column" layout-align="start stretch">

  <!-- chat wrapper with border and background -->
  <div class="chat-wrapper" style="padding:12px; border:2px solid #5c6bc0; border-radius:12px; background:#f8f9fb; box-shadow:0 2px 6px rgba(0,0,0,0.08);">

    <!-- header -->
    <div layout="row" layout-align="space-between center" style="margin-bottom:8px;">
      <h4 style="margin:0;">AI Assistant</h4>
      <!-- clear conversation button -->
      <div>
        <md-button class="md-raised md-warn" ng-click="clearConversation()" aria-label="Clear conversation">
          Clear conversation
        </md-button>
      </div>
    </div>

    <div class="chat-container">
      <!-- messages -->
      <div id="llm-messages" class="chat-messages">

        <!-- message rows with avatar + bubble -->
        <div ng-repeat="m in messages track by $index"
             class="message-row"
             ng-class="{'from-user': m.who === 'user', 'from-ai': m.who === 'ai'}"
             style="display:flex; align-items:flex-end; gap:8px;">

          <!-- AI message (left) -->
          <div ng-if="m.who === 'ai'" style="display:flex; align-items:flex-end; gap:8px;">
            <!-- avatar -->
            <div class="avatar" style="min-width:36px; height:36px; border-radius:18px; display:flex; align-items:center; justify-content:center; font-weight:600;
                 background:#e8ecff; color:#1f2b66; flex-shrink:0;">
              AI
            </div>

            <!-- bubble -->
            <div class="message ai" style="max-width:78%;">
              <span ng-bind="m.text"></span>
            </div>
          </div>

          <!-- User message (right) -->
          <div ng-if="m.who === 'user'" style="display:flex; align-items:flex-end; gap:8px; margin-left:auto;">
            <!-- bubble -->
            <div class="message user" style="max-width:78%;">
              <span ng-bind="m.text"></span>
            </div>

            <!-- avatar -->
            <div class="avatar" style="min-width:36px; height:36px; border-radius:18px; display:flex; align-items:center; justify-content:center; font-weight:600;
                 background:#3f51b5; color:#fff; flex-shrink:0;">
              You
            </div>
          </div>
        </div>

        <!-- typing indicator -->
        <div class="message-row" ng-if="llm.loading" style="display:flex; align-items:flex-end; gap:8px;">
          <div style="display:flex; align-items:flex-end; gap:8px;">
            <div class="avatar" style="min-width:36px; height:36px; border-radius:18px; display:flex; align-items:center; justify-content:center; font-weight:600;
                 background:#e8ecff; color:#1f2b66; flex-shrink:0;">
              AI
            </div>
            <div class="message ai typing" style="max-width:78%;">AI is typingâ€¦</div>
          </div>
        </div>

      </div>

      <!-- input -->
      <div class="chat-input" style="display:flex; gap:8px; align-items:center; margin-top:8px;">
        <md-input-container class="md-block" style="flex:1; margin:0;">
          <label>Write a message (Enter to send, Shift+Enter for newline)</label>
          <textarea ng-model="llm.prompt" ng-keydown="handleKeydown($event)" rows="2"></textarea>
        </md-input-container>

        <div style="display:flex; flex-direction:column; gap:6px;">
          <md-button class="md-raised md-primary" ng-click="sendToLLM()" ng-disabled="llm.loading" aria-label="Send message">
            {{ llm.loading ? 'Thinking...' : 'Send' }}
          </md-button>

          <md-button class="md-raised" ng-click="clearLLM()" ng-disabled="llm.loading" aria-label="Clear input">
            Clear
          </md-button>
        </div>
      </div>
    </div>

  </div> <!-- end chat-wrapper -->

</div>


    <!-- Example Dummy Questions -->
    <h4>Answer the following questions:</h4>
    <div ng-repeat="q in questions track by $index" style="margin-bottom: 15px;">
      <p><strong>Q{{$index + 1}}.</strong> {{q}}</p>
      <md-input-container class="md-block">
        <label>Your answer</label>
        <input type="text" ng-model="answers[$index]" />
      </md-input-container>
    </div>

    <!-- Button and error message on same line -->
    <div layout="row" layout-align="left center" style="margin-top:20px; gap:10px;">
        <md-button ng-click="submitTask()" type="submit" class="md-raised md-primary">Next stage</md-button> 

        <!-- Error message right next to button -->
        <span ng-if="msg" style="color: #8B0000; font-weight: 600;">{{msg}}</span> 
    </div>

  </md-content>
</div>
